<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>充电时长模型 · 完全体</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-dark: #3d8b40;
            --secondary-color: #2196F3;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-secondary: #666666;
            --border-color: #e1e5e9;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 10px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        header {
            text-align: center;
            padding: 0 0 20px 0;
            margin-bottom: 10px;
        }
        
        h1 {
            color: var(--text-color);
            margin-bottom: 8px;
            font-size: 2.2rem;
            font-weight: 700;
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .top-section {
            display: flex;
            gap: 24px;
            min-height: 340px;
        }
        
        .input-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .result-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            height: 100%;
        }
        
        .compact-card {
            padding: 12px;
        }
        
        .card-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 12px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .input-group {
            margin-bottom: 12px;
        }
        
        .sub-panel-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .sub-panel-row {
            display: flex;
            gap: 8px;
        }
        
        .sub-panel {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 70px;
        }
        
        .sub-panel-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
            padding-bottom: 2px;
            border-bottom: 1px dashed var(--border-color);
        }
        
        .sub-panel.full-width {
            flex: 0 0 100%;
        }
        
        .sub-panel.third-width {
            flex: 0 0 calc(33.33% - 6px);
        }
        
        .config-btn {
            width: 100%;
            padding: 6px;
            border: 1.5px dashed var(--primary-color);
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.3s;
            font-size: 0.8rem;
            flex: 1;
            min-height: 36px;
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--primary-color);
        }
        
        .config-btn:hover {
            background: rgba(76, 175, 80, 0.2);
            transform: translateY(-2px);
        }
        
        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .slider-value {
            min-width: 40px;
            font-weight: 600;
            color: var(--primary-color);
            background: rgba(76, 175, 80, 0.1);
            padding: 3px 6px;
            border-radius: 4px;
            text-align: center;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .slider-value:hover {
            background: rgba(76, 175, 80, 0.2);
            transform: scale(1.05);
        }
        
        input[type="range"] {
            flex: 1;
            height: 5px;
            -webkit-appearance: none;
            background: #e0e0e0;
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: var(--primary-dark);
        }
        
        input[type="number"] {
            width: 100%;
            padding: 7px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        input[type="number"]:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        .buttons-row {
            display: flex;
            gap: 8px;
            margin-top: 14px;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            flex: 1;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(76, 175, 80, 0.2);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }
        
        .result-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 15px;
            background: linear-gradient(135deg, #f0f9f0 0%, #e8f5e9 100%);
            border-radius: 10px;
            text-align: center;
            margin-bottom: 18px;
            min-height: 150px;
        }
        
        .result-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .result-value {
            font-size: 2.4rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 15px;
            line-height: 1.2;
        }
        
        .current-value {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-color);
            line-height: 1.3;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .stat-card {
            background: #f8fafc;
            border-radius: 8px;
            padding: 14px 12px;
            border-left: 4px solid var(--primary-color);
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stat-value {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--text-color);
            line-height: 1.2;
        }
        
        .chart-section {
            margin-top: 0;
            width: 100%;
        }
        
        .chart-container {
            height: 360px;
            width: 100%;
        }
        
        .chart-card {
            width: 100%;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: var(--radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .modal-close:hover {
            background: #f1f5f9;
            color: var(--text-color);
        }
        
        .modal-body {
            padding: 24px;
            flex: 1;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .modal-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s;
            font-size: 0.95rem;
        }
        
        .modal-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .data-textarea {
            width: 100%;
            min-height: 280px;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.3;
            tab-size: 4;
            resize: vertical;
            margin-bottom: 16px;
        }
        
        .data-textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .history-item {
            padding: 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .history-item:hover {
            border-color: var(--primary-color);
            background: rgba(76, 175, 80, 0.05);
            transform: translateX(4px);
        }
        
        .history-item.active {
            border-color: var(--primary-color);
            background: rgba(76, 175, 80, 0.1);
        }
        
        .history-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-color);
            font-size: 0.95rem;
        }
        
        .history-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            gap: 12px;
        }
        
        .history-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .history-btn {
            padding: 5px 10px;
            background: #f1f5f9;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .history-btn:hover {
            background: #e2e8f0;
        }
        
        .history-btn.delete {
            color: #e74c3c;
        }
        
        .history-btn.delete:hover {
            background: #fee;
        }
        
        .no-history {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        
        .data-preview {
            background: #f8fafc;
            border-radius: 6px;
            padding: 10px;
            margin-top: 12px;
            font-size: 0.7rem;
            max-height: 80px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        
        .preview-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
            font-size: 0.9rem;
        }
        
        footer {
            text-align: center;
            padding: 20px 0;
            color: var(--text-secondary);
            font-size: 0.85rem;
            border-top: 1px solid var(--border-color);
            margin-top: 20px;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }
        
        .footer-link {
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }
        
        .footer-link:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 1200px) {
            .top-section {
                flex-direction: column;
            }
            .chart-container {
                height: 340px;
            }
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .buttons-row {
                flex-direction: column;
            }
            h1 {
                font-size: 1.8rem;
            }
            .result-value {
                font-size: 2rem;
            }
            .sub-panel-row {
                flex-direction: column;
                gap: 10px;
            }
            .chart-container {
                height: 300px;
            }
            .top-section {
                min-height: auto;
            }
            .result-display {
                min-height: 130px;
                padding: 15px 10px;
            }
            .result-value {
                font-size: 1.8rem;
            }
            .current-value {
                font-size: 1.1rem;
            }
            .stat-card {
                min-height: 60px;
                padding: 12px 10px;
            }
            .stat-label {
                font-size: 0.8rem;
            }
            .stat-value {
                font-size: 1rem;
            }
            .sub-panel.third-width {
                flex: 0 0 100%;
            }
        }
        
        .section-divider {
            height: 1px;
            background: var(--border-color);
            margin: 12px 0;
        }
        
        .current-data-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .current-data-name {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.8rem;
        }
        
        .data-status {
            font-size: 0.7rem;
            color: var(--text-secondary);
            background: #f1f5f9;
            padding: 2px 5px;
            border-radius: 10px;
        }
        
        .data-details {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        
        .data-detail-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .input-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        }
        
        .input-modal-content {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .input-modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-color);
        }
        
        .input-modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .time-display {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 5px;
        }
        
        .time-unit {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .slider-hint {
            font-size: 0.65rem;
            color: #ff9800;
            margin-top: 3px;
            text-align: center;
            height: 12px;
            transition: opacity 0.3s;
        }
        
        .slider-hint.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .input-section .card,
        .result-section .card {
            display: flex;
            flex-direction: column;
        }
        
        .sub-panel .slider-container {
            margin-top: auto;
        }
        
        .sub-panel input[type="number"] {
            margin-top: auto;
        }
        
        .result-section .card {
            justify-content: space-between;
        }
        
        .thermal-param-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .thermal-param-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            background: #f8fafc;
        }
        
        .thermal-param-card-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid rgba(76, 175, 80, 0.2);
            padding-bottom: 6px;
        }
        
        .thermal-input-group {
            margin-bottom: 12px;
        }
        
        .thermal-input-group label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
        }
        
        .thermal-input-group input[type="number"] {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .thermal-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 12px 16px;
            background: rgba(76, 175, 80, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }
        
        .thermal-toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .thermal-toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .thermal-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .thermal-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .thermal-toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        .thermal-toggle-switch input:checked + .thermal-toggle-slider {
            background-color: var(--primary-color);
        }
        
        .thermal-toggle-switch input:checked + .thermal-toggle-slider:before {
            transform: translateX(24px);
        }
        
        .temp-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(76, 175, 80, 0.05);
            border-radius: 6px;
            border-left: 4px solid var(--primary-color);
        }
        
        .temp-status-icon {
            color: var(--primary-color);
            font-size: 1.2rem;
        }
        
        .temp-status-text {
            font-size: 0.8rem;
            color: #666;
        }
        
        .temp-status-value {
            font-weight: 600;
            color: var(--primary-color);
            margin-left: auto;
        }
        
        .thermal-config-name {
            margin-top: 20px;
        }
        
        .thermal-config-name label {
            font-size: 0.85rem;
            color: var(--text-color);
        }
        
        .thermal-config-name input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        .data-validation-status {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            display: none;
        }
        
        .data-validation-status.valid {
            background-color: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: var(--primary-color);
        }
        
        .data-validation-status.invalid {
            background-color: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            color: #e74c3c;
        }
        
        .data-preview-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .data-preview-buttons .btn {
            font-size: 0.8rem;
            padding: 4px 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-charging-station"></i> 充电时长模型</h1>
            <p class="subtitle">基于双线性插值算法与微积分模拟，精确预测不同条件下的充电时间</p>
        </header>
        
        <div class="top-section">
            <div class="input-section">
                <div class="card compact-card">
                    <div class="card-title">
                        <i class="fas fa-sliders-h"></i> 参数配置
                    </div>
                    
                    <div class="sub-panel-grid">
                        <div class="sub-panel-row">
                            <div class="sub-panel third-width">
                                <div class="sub-panel-title">
                                    <i class="fas fa-map"></i> 充电map配置
                                </div>
                                <button class="config-btn" id="open-data-modal">
                                    <i class="fas fa-database"></i>
                                    配置充电map
                                </button>
                            </div>
                            
                            <div class="sub-panel third-width">
                                <div class="sub-panel-title">
                                    <i class="fas fa-fire"></i> 电池温升配置
                                </div>
                                <button class="config-btn" id="open-thermal-modal">
                                    <i class="fas fa-thermometer-half"></i>
                                    配置温升模型
                                </button>
                            </div>
                            
                            <div class="sub-panel third-width">
                                <div class="sub-panel-title">
                                    <i class="fas fa-car-battery"></i> 电池容量 (Ah)
                                </div>
                                <input type="number" id="capacity" min="1" max="200" step="1" value="80">
                            </div>
                        </div>
                        
                        <div class="sub-panel-row">
                            <div class="sub-panel">
                                <div class="sub-panel-title">
                                    <i class="fas fa-battery-quarter"></i> 起始SOC (%)
                                </div>
                                <div class="slider-container">
                                    <input type="range" id="start-soc" min="0" max="100" step="0.5" value="10">
                                    <span class="slider-value" id="start-soc-value">10.0</span>
                                </div>
                                <div class="slider-hint hidden" id="start-soc-hint"></div>
                            </div>
                            
                            <div class="sub-panel">
                                <div class="sub-panel-title">
                                    <i class="fas fa-battery-full"></i> 目标SOC (%)
                                </div>
                                <div class="slider-container">
                                    <input type="range" id="end-soc" min="0" max="100" step="0.5" value="80">
                                    <span class="slider-value" id="end-soc-value">80.0</span>
                                </div>
                                <div class="slider-hint hidden" id="end-soc-hint">目标SOC需大于起始SOC</div>
                            </div>
                        </div>
                        
                        <div class="sub-panel-row">
                            <div class="sub-panel full-width">
                                <div class="sub-panel-title">
                                    <i class="fas fa-thermometer-half"></i> 环境温度 (°C)
                                </div>
                                <div class="slider-container">
                                    <input type="range" id="temperature" min="-10" max="50" step="0.5" value="25">
                                    <span class="slider-value" id="temperature-value">25.0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-divider"></div>
                    
                    <div class="data-preview">
                        <div class="current-data-info">
                            <div class="current-data-name" id="current-data-name">参数配置总览</div>
                            <div class="data-status" id="data-status">已加载</div>
                        </div>
                        <div class="data-details">
                            <div class="data-detail-item">
                                <i class="fas fa-thermometer-half"></i>
                                <span id="temp-range">-10°C ~ 40°C</span>
                            </div>
                            <div class="data-detail-item">
                                <i class="fas fa-battery-three-quarters"></i>
                                <span id="soc-range">0% ~ 100%</span>
                            </div>
                            <div class="data-detail-item">
                                <i class="fas fa-table"></i>
                                <span id="data-points">5×6 矩阵</span>
                            </div>
                            <div class="data-detail-item">
                                <i class="fas fa-fire"></i>
                                <span id="thermal-status">温升: 未启用</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="buttons-row">
                        <button id="calculate-btn" class="btn btn-primary">
                            <i class="fas fa-bolt"></i> 计算
                        </button>
                        <button id="reset-btn" class="btn btn-secondary">
                            <i class="fas fa-redo"></i> 重置
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="result-section">
                <div class="card compact-card">
                    <div class="card-title">
                        <i class="fas fa-chart-bar"></i> 计算结果
                    </div>
                    
                    <div class="result-display">
                        <div class="result-label">预计充电时长</div>
                        <div class="time-display">
                            <div class="result-value" id="result-time">--</div>
                        </div>
                        <div class="result-label">当前充电电流</div>
                        <div class="current-value" id="current-current">-- A</div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label"><i class="fas fa-tachometer-alt"></i> 平均电流</div>
                            <div class="stat-value" id="avg-current">-- A</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label"><i class="fas fa-battery-three-quarters"></i> SOC增量</div>
                            <div class="stat-value" id="soc-increment">-- %</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label"><i class="fas fa-car"></i> 电池容量</div>
                            <div class="stat-value" id="capacity-value">80 Ah</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label"><i class="fas fa-calculator"></i> 计算步数</div>
                            <div class="stat-value" id="steps-count">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chart-section">
            <div class="card chart-card">
                <div class="card-title">
                    <i class="fas fa-chart-line"></i> 充电过程可视化
                </div>
                <div id="chart-container" class="chart-container"></div>
            </div>
        </div>
        
        <!-- 充电map配置模态框 -->
        <div class="modal-overlay" id="data-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title"><i class="fas fa-database"></i> 充电map配置</div>
                    <button class="modal-close" id="close-data-modal">&times;</button>
                </div>
                
                <div class="modal-tabs">
                    <button class="modal-tab active" data-tab="data-input">数据输入</button>
                    <button class="modal-tab" data-tab="data-history">历史记录</button>
                </div>
                
                <div class="modal-body">
                    <div class="tab-content active" id="data-input-tab">
                        <div class="input-group">
                            <label><i class="fas fa-table"></i> 充电map数据（从Excel粘贴）</label>
                            
                            <div class="data-preview-buttons">
                                <button class="btn btn-secondary" id="load-example-btn">
                                    <i class="fas fa-eye"></i> 查看示例格式
                                </button>
                                <button class="btn btn-secondary" id="clear-data-btn">
                                    <i class="fas fa-trash"></i> 清空
                                </button>
                            </div>
                            
                            <textarea class="data-textarea" id="data-input" placeholder="请从Excel复制数据并粘贴到这里（使用制表符或空格分隔）...
示例格式：
温度\SOC    0    20    40    60    80    100
-10         0    50    80    100   120   100
0           20   80    120   150   180   150
10          50   100   150   200   250   200
25          100  150   200   250   300   250
40          80   130   180   230   280   230"></textarea>
                            
                            <div class="data-validation-status" id="data-validation-status">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span id="validation-icon"></span>
                                    <span id="validation-message"></span>
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <label for="data-name"><i class="fas fa-tag"></i> 数据名称（可选）</label>
                                <input type="text" id="data-name" placeholder="例如：Model X 充电map">
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="data-history-tab">
                        <div class="history-list" id="data-history-list"></div>
                        <div class="no-history" id="data-no-history" style="display: none;">
                            <i class="fas fa-history" style="font-size: 3rem; margin-bottom: 16px; color: #ccc;"></i>
                            <p>暂无历史记录</p>
                            <p style="font-size: 0.9rem; margin-top: 8px;">保存的数据将显示在这里</p>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-data-modal">取消</button>
                    <button class="btn btn-primary" id="save-data">保存并应用</button>
                </div>
            </div>
        </div>
        
        <!-- 电池温升配置模态框 -->
        <div class="modal-overlay" id="thermal-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title"><i class="fas fa-fire"></i> 电池温升模型配置</div>
                    <button class="modal-close" id="close-thermal-modal">&times;</button>
                </div>
                
                <div class="modal-tabs">
                    <button class="modal-tab active" data-tab="thermal-config">参数配置</button>
                    <button class="modal-tab" data-tab="thermal-history">历史配置</button>
                </div>
                
                <div class="modal-body">
                    <div class="tab-content active" id="thermal-config-tab">
                        <div class="thermal-toggle">
                            <div class="thermal-toggle-label">
                                <i class="fas fa-power-off"></i>
                                <span>启用温度变化计算</span>
                            </div>
                            <label class="thermal-toggle-switch">
                                <input type="checkbox" id="enable-temp-change-modal">
                                <span class="thermal-toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="thermal-param-grid">
                            <div class="thermal-param-card">
                                <div class="thermal-param-card-title">
                                    <i class="fas fa-weight"></i> 电池物理参数
                                </div>
                                <div class="thermal-input-group">
                                    <label for="battery-mass-modal">电池质量 (kg)</label>
                                    <input type="number" id="battery-mass-modal" min="50" max="1000" step="1" value="300">
                                </div>
                                <div class="thermal-input-group">
                                    <label for="specific-heat-modal">比热容 (J/kg·K)</label>
                                    <input type="number" id="specific-heat-modal" min="500" max="2000" step="10" value="900">
                                </div>
                            </div>
                            
                            <div class="thermal-param-card">
                                <div class="thermal-param-card-title">
                                    <i class="fas fa-bolt"></i> 电热参数
                                </div>
                                <div class="thermal-input-group">
                                    <label for="thermal-resistance-modal">热阻系数 (K/W)</label>
                                    <input type="number" id="thermal-resistance-modal" min="0.01" max="2" step="0.01" value="0.2">
                                </div>
                                <div class="thermal-input-group">
                                    <label for="internal-resistance-modal">内阻 (Ω)</label>
                                    <input type="number" id="internal-resistance-modal" min="0.001" max="0.1" step="0.001" value="0.05">
                                </div>
                            </div>
                        </div>
                        
                        <div class="temp-status-indicator" id="temp-status-indicator">
                            <div class="temp-status-icon">
                                <i class="fas fa-thermometer-half"></i>
                            </div>
                            <div class="temp-status-text">
                                温升模型状态
                            </div>
                            <div class="temp-status-value" id="temp-status-value">未启用</div>
                        </div>
                        
                        <div class="thermal-config-name">
                            <div class="input-group">
                                <label for="thermal-config-name-input"><i class="fas fa-tag"></i> 配置名称（可选）</label>
                                <input type="text" id="thermal-config-name-input" placeholder="例如：Model X 温升模型" value="温升配置总览">
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="thermal-history-tab">
                        <div class="history-list" id="thermal-history-list"></div>
                        <div class="no-history" id="thermal-no-history" style="display: none;">
                            <i class="fas fa-history" style="font-size: 3rem; margin-bottom: 16px; color: #ccc;"></i>
                            <p>暂无历史配置</p>
                            <p style="font-size: 0.9rem; margin-top: 8px;">保存的配置将显示在这里</p>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-thermal-modal">取消</button>
                    <button class="btn btn-primary" id="save-thermal-config">保存并应用</button>
                </div>
            </div>
        </div>
        
        <!-- 数值输入模态框 -->
        <div class="input-modal" id="value-input-modal">
            <div class="input-modal-content">
                <div class="input-modal-title" id="value-input-title">输入数值</div>
                <div class="input-group">
                    <input type="number" id="value-input" min="0" max="100" step="0.5">
                </div>
                <div class="input-modal-actions">
                    <button class="btn btn-secondary" id="value-input-cancel">取消</button>
                    <button class="btn btn-primary" id="value-input-ok">确定</button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>充电时长模型 v2.8 | 基于双线性插值与微积分模拟 | 集成集中参数热模型</p>
            <div class="footer-links">
                <a href="#" class="footer-link" id="export-report"><i class="fas fa-file-export"></i> 导出报告</a>
                <a href="#" class="footer-link" id="clear-history"><i class="fas fa-trash-alt"></i> 清空历史</a>
                <a href="#" class="footer-link" id="help-link"><i class="fas fa-question-circle"></i> 使用帮助</a>
            </div>
        </footer>
    </div>

    <script>
        // ---------- 全局变量 ----------
        let currentMatrixData = null;
        let chartInstance = null;
        let simulationResults = null;
        let currentDataName = "默认数据";
        let historyData = [];
        let thermalHistoryData = [];
        let currentInputTarget = null;
        let hintTimeout = null;
        
        // 温度变化相关全局变量
        let enableTempChange = false;
        let thermalParams = {
            batteryMass: 300,
            specificHeat: 900,
            thermalResistance: 0.2,
            internalResistance: 0.05
        };
        let temperatureHistory = [];
        
        // ---------- 从localStorage加载历史数据 ----------
        function loadHistory() {
            const saved = localStorage.getItem('chargingSimulatorHistory');
            if (saved) {
                try {
                    historyData = JSON.parse(saved);
                    updateHistoryList('data');
                } catch (e) {
                    console.error("加载充电map历史数据失败:", e);
                    historyData = [];
                }
            }
            
            const thermalSaved = localStorage.getItem('thermalConfigHistory');
            if (thermalSaved) {
                try {
                    thermalHistoryData = JSON.parse(thermalSaved);
                    updateHistoryList('thermal');
                } catch (e) {
                    console.error("加载温升模型历史数据失败:", e);
                    thermalHistoryData = [];
                }
            }
            
            const thermalConfig = localStorage.getItem('thermalConfig');
            if (thermalConfig) {
                try {
                    const config = JSON.parse(thermalConfig);
                    enableTempChange = config.enableTempChange || false;
                    thermalParams = config.thermalParams || thermalParams;
                    
                    document.getElementById('enable-temp-change-modal').checked = enableTempChange;
                    document.getElementById('battery-mass-modal').value = thermalParams.batteryMass;
                    document.getElementById('specific-heat-modal').value = thermalParams.specificHeat;
                    document.getElementById('thermal-resistance-modal').value = thermalParams.thermalResistance;
                    document.getElementById('internal-resistance-modal').value = thermalParams.internalResistance;
                    
                    const configNameInput = document.getElementById('thermal-config-name-input');
                    if (configNameInput) {
                        configNameInput.value = config.configName || "温升配置总览";
                    }
                    
                    updateThermalPreview();
                    updateDataPreview();
                } catch (e) {
                    console.error("加载温升模型配置失败:", e);
                }
            }
        }
        
        // ---------- 保存历史数据 ----------
        function saveHistory() {
            localStorage.setItem('chargingSimulatorHistory', JSON.stringify(historyData));
            localStorage.setItem('thermalConfigHistory', JSON.stringify(thermalHistoryData));
            
            const configNameInput = document.getElementById('thermal-config-name-input');
            const thermalConfig = {
                enableTempChange: enableTempChange,
                thermalParams: thermalParams,
                configName: configNameInput ? configNameInput.value.trim() : "温升配置总览"
            };
            localStorage.setItem('thermalConfig', JSON.stringify(thermalConfig));
        }
        
        // ---------- 更新历史记录列表 ----------
        function updateHistoryList(type) {
            const listId = type === 'data' ? 'data-history-list' : 'thermal-history-list';
            const noHistoryId = type === 'data' ? 'data-no-history' : 'thermal-no-history';
            const historyArray = type === 'data' ? historyData : thermalHistoryData;
            
            const historyList = document.getElementById(listId);
            const noHistory = document.getElementById(noHistoryId);
            
            if (historyArray.length === 0) {
                historyList.innerHTML = '';
                noHistory.style.display = 'block';
                return;
            }
            
            noHistory.style.display = 'none';
            historyList.innerHTML = '';
            
            const sortedHistory = [...historyArray].sort((a, b) => b.timestamp - a.timestamp);
            
            sortedHistory.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const date = new Date(item.timestamp);
                const timeStr = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                if (type === 'data') {
                    const isActive = item.name === currentDataName;
                    if (isActive) historyItem.classList.add('active');
                    
                    historyItem.innerHTML = `
                        <div class="history-title">${item.name || '未命名数据'}</div>
                        <div class="history-meta">
                            <span>${item.tempCount}个温度点</span>
                            <span>${item.socCount}个SOC点</span>
                            <span>${timeStr}</span>
                        </div>
                        <div class="history-actions">
                            <button class="history-btn apply" data-type="data" data-index="${index}">应用</button>
                            <button class="history-btn delete" data-type="data" data-index="${index}">删除</button>
                        </div>
                    `;
                } else {
                    const isActive = item.isCurrent;
                    if (isActive) historyItem.classList.add('active');
                    
                    historyItem.innerHTML = `
                        <div class="history-title">${item.name || '未命名配置'}</div>
                        <div class="history-meta">
                            <span>${item.enabled ? '已启用' : '未启用'}</span>
                            <span>质量: ${item.params.batteryMass}kg</span>
                            <span>${timeStr}</span>
                        </div>
                        <div class="history-actions">
                            <button class="history-btn apply" data-type="thermal" data-index="${index}">应用</button>
                            <button class="history-btn delete" data-type="thermal" data-index="${index}">删除</button>
                        </div>
                    `;
                }
                
                historyList.appendChild(historyItem);
            });
            
            document.querySelectorAll(`#${listId} .history-btn.apply`).forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    const dataType = this.getAttribute('data-type');
                    if (dataType === 'data') applyHistoryItem(index);
                    else applyThermalHistoryItem(index);
                });
            });
            
            document.querySelectorAll(`#${listId} .history-btn.delete`).forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    const dataType = this.getAttribute('data-type');
                    if (dataType === 'data') deleteHistoryItem(index);
                    else deleteThermalHistoryItem(index);
                });
            });
        }
        
        function applyHistoryItem(index) {
            if (index >= 0 && index < historyData.length) {
                const item = historyData[index];
                document.getElementById('data-input').value = item.data;
                if (item.name) document.getElementById('data-name').value = item.name;
                currentDataName = item.name || "默认数据";
                switchTab('data-input', 'data-modal');
                parseDataFromInput();
                updateDataPreview();
                if (currentMatrixData) simulateAndUpdate();
            }
        }
        
        function applyThermalHistoryItem(index) {
            if (index >= 0 && index < thermalHistoryData.length) {
                const item = thermalHistoryData[index];
                enableTempChange = item.enabled;
                thermalParams = item.params;
                
                document.getElementById('enable-temp-change-modal').checked = enableTempChange;
                document.getElementById('battery-mass-modal').value = thermalParams.batteryMass;
                document.getElementById('specific-heat-modal').value = thermalParams.specificHeat;
                document.getElementById('thermal-resistance-modal').value = thermalParams.thermalResistance;
                document.getElementById('internal-resistance-modal').value = thermalParams.internalResistance;
                
                const configNameInput = document.getElementById('thermal-config-name-input');
                if (configNameInput) configNameInput.value = item.name || "温升配置总览";
                
                updateThermalPreview();
                updateDataPreview();
                if (currentMatrixData) simulateAndUpdate();
                
                thermalHistoryData.forEach((item, idx) => { item.isCurrent = (idx === index); });
                saveHistory();
                updateHistoryList('thermal');
            }
        }
        
        function deleteHistoryItem(index) {
            if (index >= 0 && index < historyData.length) {
                historyData.splice(index, 1);
                saveHistory();
                updateHistoryList('data');
            }
        }
        
        function deleteThermalHistoryItem(index) {
            if (index >= 0 && index < thermalHistoryData.length) {
                thermalHistoryData.splice(index, 1);
                saveHistory();
                updateHistoryList('thermal');
            }
        }
        
        function addToHistory() {
            if (!currentMatrixData) return;
            const dataInput = document.getElementById('data-input').value.trim();
            const name = document.getElementById('data-name').value.trim() || `充电map ${new Date().toLocaleString()}`;
            const existingIndex = historyData.findIndex(item => item.data === dataInput);
            const historyItem = {
                name: name,
                data: dataInput,
                tempCount: currentMatrixData.tempAxis.length,
                socCount: currentMatrixData.socAxis.length,
                timestamp: Date.now()
            };
            if (existingIndex >= 0) historyData[existingIndex] = historyItem;
            else historyData.push(historyItem);
            saveHistory();
            updateHistoryList('data');
            currentDataName = name;
        }
        
        function addThermalToHistory(name) {
            const historyItem = {
                name: name || `温升配置 ${new Date().toLocaleString()}`,
                enabled: enableTempChange,
                params: {...thermalParams},
                timestamp: Date.now(),
                isCurrent: true
            };
            thermalHistoryData.forEach(item => { item.isCurrent = false; });
            const existingIndex = thermalHistoryData.findIndex(item => 
                item.enabled === historyItem.enabled &&
                item.params.batteryMass === historyItem.params.batteryMass &&
                item.params.specificHeat === historyItem.params.specificHeat &&
                item.params.thermalResistance === historyItem.params.thermalResistance &&
                item.params.internalResistance === historyItem.params.internalResistance
            );
            if (existingIndex >= 0) thermalHistoryData[existingIndex] = historyItem;
            else thermalHistoryData.push(historyItem);
            saveHistory();
            updateHistoryList('thermal');
        }
        
        function switchTab(tabName, modalId) {
            const modal = document.getElementById(modalId);
            modal.querySelectorAll('.modal-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabName) tab.classList.add('active');
            });
            modal.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === `${tabName}-tab`) content.classList.add('active');
            });
        }
        
        function formatDataForDisplay(data) {
            const lines = data.split('\n');
            if (lines.length < 2) return data;
            const rows = lines.map(line => line.split(/\t|\s{2,}/));
            const maxWidths = [];
            rows.forEach(row => {
                row.forEach((cell, colIndex) => {
                    if (!maxWidths[colIndex] || cell.length > maxWidths[colIndex]) maxWidths[colIndex] = cell.length;
                });
            });
            const formattedRows = rows.map(row => {
                return row.map((cell, colIndex) => cell.padEnd(maxWidths[colIndex], ' ')).join('  ');
            });
            return formattedRows.join('\n');
        }
        
        // ---------- DOM加载完成初始化 ----------
        document.addEventListener('DOMContentLoaded', function() {
            initEventListeners();
            initChart();
            loadHistory();
            
            const defaultData = `温度\\SOC    0    20    40    60    80    100
-10         0    50    80    100   120   100
0           20   80    120   150   180   150
10          50   100   150   200   250   200
25          100  150   200   250   300   250
40          80   130   180   230   280   230`;
            
            document.getElementById('data-input').value = formatDataForDisplay(defaultData);
            
            if (parseDataFromInput()) {
                updateDataPreview();
                currentDataName = "默认数据";
                const historyItem = {
                    name: "默认数据",
                    data: defaultData,
                    tempCount: currentMatrixData.tempAxis.length,
                    socCount: currentMatrixData.socAxis.length,
                    timestamp: Date.now()
                };
                historyData.push(historyItem);
                saveHistory();
                updateHistoryList('data');
            }
            
            updateThermalPreview();
            
            setTimeout(() => {
                simulateAndUpdate();
            }, 500);
        });
        
        function showHint(message, duration = 2000) {
            const hintElement = document.getElementById('end-soc-hint');
            hintElement.textContent = message;
            hintElement.classList.remove('hidden');
            if (hintTimeout) clearTimeout(hintTimeout);
            hintTimeout = setTimeout(() => { hintElement.classList.add('hidden'); }, duration);
        }
        
        function updateEndSOCRange() {
            const startSOC = parseFloat(document.getElementById('start-soc').value);
            const endSlider = document.getElementById('end-soc');
            const endValue = parseFloat(endSlider.value);
            if (startSOC > endValue) {
                endSlider.value = startSOC;
                document.getElementById('end-soc-value').textContent = startSOC.toFixed(1);
            }
        }
        
        function openValueInputModal(target, title, min, max, currentValue) {
            currentInputTarget = target;
            document.getElementById('value-input-title').textContent = title;
            document.getElementById('value-input').min = min;
            document.getElementById('value-input').max = max;
            document.getElementById('value-input').value = currentValue;
            document.getElementById('value-input-modal').style.display = 'flex';
            document.getElementById('value-input').focus();
            document.getElementById('value-input').select();
        }
        
        function closeValueInputModal() {
            document.getElementById('value-input-modal').style.display = 'none';
            currentInputTarget = null;
        }
        
        function validateChargingMapData(dataInput) {
            try {
                const lines = dataInput.split('\n').map(line => line.trim()).filter(line => line);
                if (lines.length < 2) return false;
                const header = lines[0].split(/\t|\s{2,}/);
                if (header.length < 2) return false;
                const firstHeader = header[0].toLowerCase();
                if (!firstHeader.includes('温度') || !firstHeader.includes('soc')) return false;
                const socAxis = header.slice(1).map(val => parseFloat(val));
                if (socAxis.some(isNaN)) return false;
                for (let i = 1; i < lines.length; i++) {
                    const row = lines[i].split(/\t|\s{2,}/);
                    if (row.length !== header.length) return false;
                    if (isNaN(parseFloat(row[0]))) return false;
                    for (let j = 1; j < row.length; j++) {
                        if (isNaN(parseFloat(row[j]))) return false;
                    }
                }
                return true;
            } catch (error) {
                return false;
            }
        }
        
        function updateDataPreviewFromInput() {
            const dataInput = document.getElementById('data-input').value.trim();
            if (!dataInput) {
                document.getElementById('current-data-name').textContent = '等待数据加载...';
                document.getElementById('data-status').textContent = '未加载';
                document.getElementById('temp-range').textContent = '--';
                document.getElementById('soc-range').textContent = '--';
                document.getElementById('data-points').textContent = '--';
                return;
            }
            try {
                const lines = dataInput.split('\n').map(line => line.trim()).filter(line => line);
                if (lines.length < 2) { document.getElementById('data-status').textContent = '格式错误'; return; }
                const header = lines[0].split(/\t|\s{2,}/);
                const socAxis = header.slice(1).map(val => parseFloat(val));
                const tempAxis = [];
                for (let i = 1; i < lines.length; i++) {
                    const row = lines[i].split(/\t|\s{2,}/);
                    if (row.length < 2) continue;
                    const temp = parseFloat(row[0]);
                    if (!isNaN(temp)) tempAxis.push(temp);
                }
                if (tempAxis.length === 0 || socAxis.length === 0) {
                    document.getElementById('data-status').textContent = '数据无效';
                    return;
                }
                const tempMin = Math.min(...tempAxis);
                const tempMax = Math.max(...tempAxis);
                const socMin = Math.min(...socAxis);
                const socMax = Math.max(...socAxis);
                document.getElementById('current-data-name').textContent = '输入预览';
                document.getElementById('data-status').textContent = '待保存';
                document.getElementById('temp-range').textContent = `${tempMin}°C ~ ${tempMax}°C`;
                document.getElementById('soc-range').textContent = `${socMin}% ~ ${socMax}%`;
                document.getElementById('data-points').textContent = `${tempAxis.length}×${socAxis.length} 矩阵`;
            } catch (error) {
                document.getElementById('data-status').textContent = '解析错误';
            }
        }
        
        // ---------- 事件监听初始化 ----------
        function initEventListeners() {
            document.getElementById('temperature').addEventListener('input', function() {
                const value = parseFloat(this.value);
                document.getElementById('temperature-value').textContent = value.toFixed(1);
                updateCurrentValue();
                if (currentMatrixData) simulateAndUpdate();
            });
            
            document.getElementById('start-soc').addEventListener('input', function() {
                const startValue = parseFloat(this.value);
                const endSlider = document.getElementById('end-soc');
                const endValue = parseFloat(endSlider.value);
                document.getElementById('start-soc-value').textContent = startValue.toFixed(1);
                if (startValue > endValue) {
                    endSlider.value = startValue;
                    document.getElementById('end-soc-value').textContent = startValue.toFixed(1);
                }
                updateCurrentValue();
                if (currentMatrixData) simulateAndUpdate();
            });
            
            document.getElementById('end-soc').addEventListener('input', function() {
                const endValue = parseFloat(this.value);
                const startValue = parseFloat(document.getElementById('start-soc').value);
                if (endValue < startValue) {
                    showHint('目标SOC需大于起始SOC');
                    this.value = startValue;
                    document.getElementById('end-soc-value').textContent = startValue.toFixed(1);
                } else {
                    document.getElementById('end-soc-value').textContent = endValue.toFixed(1);
                    document.getElementById('end-soc-hint').classList.add('hidden');
                }
                if (currentMatrixData) simulateAndUpdate();
            });
            
            document.getElementById('capacity').addEventListener('input', function() {
                document.getElementById('capacity-value').textContent = this.value + ' Ah';
                if (currentMatrixData) simulateAndUpdate();
            });
            
            document.getElementById('calculate-btn').addEventListener('click', simulateAndUpdate);
            
            document.getElementById('reset-btn').addEventListener('click', resetSimulation);
            
            document.getElementById('open-data-modal').addEventListener('click', function() { openModal('data-modal'); });
            document.getElementById('open-thermal-modal').addEventListener('click', function() { openModal('thermal-modal'); });
            document.getElementById('close-data-modal').addEventListener('click', function() { closeModal('data-modal'); });
            document.getElementById('close-thermal-modal').addEventListener('click', function() { closeModal('thermal-modal'); });
            document.getElementById('cancel-data-modal').addEventListener('click', function() { closeModal('data-modal'); });
            document.getElementById('cancel-thermal-modal').addEventListener('click', function() { closeModal('thermal-modal'); });
            
            document.getElementById('save-data').addEventListener('click', saveAndApplyData);
            
            document.getElementById('save-thermal-config').addEventListener('click', function() {
                enableTempChange = document.getElementById('enable-temp-change-modal').checked;
                thermalParams = {
                    batteryMass: parseFloat(document.getElementById('battery-mass-modal').value),
                    specificHeat: parseFloat(document.getElementById('specific-heat-modal').value),
                    thermalResistance: parseFloat(document.getElementById('thermal-resistance-modal').value),
                    internalResistance: parseFloat(document.getElementById('internal-resistance-modal').value)
                };
                const configNameInput = document.getElementById('thermal-config-name-input').value.trim();
                const configName = configNameInput || `温升配置 ${new Date().toLocaleString()}`;
                addThermalToHistory(configName);
                updateThermalPreview();
                updateDataPreview();
                closeModal('thermal-modal');
                if (currentMatrixData) simulateAndUpdate();
            });
            
            document.getElementById('value-input-cancel').addEventListener('click', closeValueInputModal);
            document.getElementById('value-input-ok').addEventListener('click', function() {
                const value = parseFloat(document.getElementById('value-input').value);
                const target = currentInputTarget;
                if (!isNaN(value) && target) {
                    if (target === 'start-soc') {
                        const startSlider = document.getElementById('start-soc');
                        const min = parseFloat(startSlider.min), max = parseFloat(startSlider.max);
                        const clampedValue = Math.max(min, Math.min(max, value));
                        startSlider.value = clampedValue;
                        document.getElementById('start-soc-value').textContent = clampedValue.toFixed(1);
                        updateEndSOCRange();
                    } else if (target === 'end-soc') {
                        const startSlider = document.getElementById('start-soc');
                        const endSlider = document.getElementById('end-soc');
                        const startValue = parseFloat(startSlider.value);
                        const max = parseFloat(endSlider.max);
                        const clampedValue = Math.max(startValue, Math.min(max, value));
                        endSlider.value = clampedValue;
                        document.getElementById('end-soc-value').textContent = clampedValue.toFixed(1);
                        document.getElementById('end-soc-hint').classList.add('hidden');
                    } else if (target === 'temperature') {
                        const tempSlider = document.getElementById('temperature');
                        const tempMin = parseFloat(tempSlider.min), tempMax = parseFloat(tempSlider.max);
                        const clampedValue = Math.max(tempMin, Math.min(tempMax, value));
                        tempSlider.value = clampedValue;
                        document.getElementById('temperature-value').textContent = clampedValue.toFixed(1);
                    }
                    updateCurrentValue();
                    if (currentMatrixData) simulateAndUpdate();
                }
                closeValueInputModal();
            });
            
            document.getElementById('value-input-modal').addEventListener('click', function(e) {
                if (e.target === this) closeValueInputModal();
            });
            
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    const modal = this.closest('.modal-content').parentElement;
                    const modalId = modal.id;
                    switchTab(tabName, modalId);
                });
            });
            
            document.getElementById('export-report').addEventListener('click', function(e) {
                e.preventDefault();
                exportReport();
            });
            
            document.getElementById('clear-history').addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('确定要清空所有历史记录吗？此操作不可撤销。')) clearHistory();
            });
            
            document.getElementById('help-link').addEventListener('click', function(e) {
                e.preventDefault();
                alert('使用说明：\n1. 点击"配置充电map"按钮输入数据\n2. 点击"配置温升模型"按钮设置温度参数\n3. 调整各项参数\n4. 点击"计算"按钮\n5. 查看右侧计算结果和下方图表\n\n提示：\n- 双击SOC或温度数值可输入精确值\n- 温度滑块范围会根据矩阵数据自动调整\n- 目标SOC小于起始SOC时会自动调整\n\n温度变化模型：\n- 在温升模型配置中启用温度变化计算\n- 可配置电池质量、比热容、热阻和内阻参数');
            });
            
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) closeModal(this.id);
                });
            });
            
            document.getElementById('start-soc-value').addEventListener('dblclick', function(e) {
                const startSlider = document.getElementById('start-soc');
                const min = parseFloat(startSlider.min), max = parseFloat(startSlider.max);
                openValueInputModal('start-soc', '起始SOC (%)', min, max, parseFloat(startSlider.value));
            });
            
            document.getElementById('end-soc-value').addEventListener('dblclick', function(e) {
                const startSlider = document.getElementById('start-soc');
                const endSlider = document.getElementById('end-soc');
                const startValue = parseFloat(startSlider.value);
                const max = parseFloat(endSlider.max);
                openValueInputModal('end-soc', '目标SOC (%)', startValue, max, parseFloat(endSlider.value));
            });
            
            document.getElementById('temperature-value').addEventListener('dblclick', function(e) {
                const tempSlider = document.getElementById('temperature');
                const tempMin = parseFloat(tempSlider.min), tempMax = parseFloat(tempSlider.max);
                openValueInputModal('temperature', '环境温度 (°C)', tempMin, tempMax, parseFloat(tempSlider.value));
            });
            
            document.getElementById('temperature').addEventListener('dblclick', function(e) {
                const tempSlider = document.getElementById('temperature');
                const tempMin = parseFloat(tempSlider.min), tempMax = parseFloat(tempSlider.max);
                openValueInputModal('temperature', '环境温度 (°C)', tempMin, tempMax, parseFloat(tempSlider.value));
            });
            
            document.getElementById('start-soc').addEventListener('dblclick', function(e) {
                const startSlider = document.getElementById('start-soc');
                const min = parseFloat(startSlider.min), max = parseFloat(startSlider.max);
                openValueInputModal('start-soc', '起始SOC (%)', min, max, parseFloat(startSlider.value));
            });
            
            document.getElementById('end-soc').addEventListener('dblclick', function(e) {
                const startSlider = document.getElementById('start-soc');
                const endSlider = document.getElementById('end-soc');
                const startValue = parseFloat(startSlider.value);
                const max = parseFloat(endSlider.max);
                openValueInputModal('end-soc', '目标SOC (%)', startValue, max, parseFloat(endSlider.value));
            });
            
            document.getElementById('enable-temp-change-modal').addEventListener('change', function() {
                updateTempStatusIndicator();
                updateDataPreview();
            });
            
            ['battery-mass-modal', 'specific-heat-modal', 'thermal-resistance-modal', 'internal-resistance-modal'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateTempStatusIndicator);
            });
            
            document.getElementById('data-input').addEventListener('input', function() {
                const dataInput = this.value.trim();
                const validationDiv = document.getElementById('data-validation-status');
                if (!dataInput) { validationDiv.style.display = 'none'; return; }
                const isValid = validateChargingMapData(dataInput);
                validationDiv.style.display = 'block';
                if (isValid) {
                    validationDiv.className = 'data-validation-status valid';
                    document.getElementById('validation-icon').innerHTML = '<i class="fas fa-check-circle"></i>';
                    document.getElementById('validation-message').textContent = '数据格式正确';
                    parseDataFromInput();
                    updateDataPreviewFromInput();
                } else {
                    validationDiv.className = 'data-validation-status invalid';
                    document.getElementById('validation-icon').innerHTML = '<i class="fas fa-exclamation-circle"></i>';
                    document.getElementById('validation-message').textContent = '数据格式有误，请检查';
                }
            });
            
            document.getElementById('load-example-btn').addEventListener('click', function() {
                const exampleData = `温度\\SOC    0    20    40    60    80    100
-10         0    50    80    100   120   100
0           20   80    120   150   180   150
10          50   100   150   200   250   200
25          100  150   200   250   300   250
40          80   130   180   230   280   230`;
                const formattedData = formatDataForDisplay(exampleData);
                document.getElementById('data-input').value = formattedData;
                const event = new Event('input', { bubbles: true });
                document.getElementById('data-input').dispatchEvent(event);
            });
            
            document.getElementById('clear-data-btn').addEventListener('click', function() {
                document.getElementById('data-input').value = '';
                document.getElementById('data-name').value = '';
                document.getElementById('data-validation-status').style.display = 'none';
                const event = new Event('input', { bubbles: true });
                document.getElementById('data-input').dispatchEvent(event);
            });
        }
        
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function saveAndApplyData() {
            const dataInput = document.getElementById('data-input').value.trim();
            const dataNameInput = document.getElementById('data-name').value.trim();
            if (!dataInput) { alert("请输入充电map数据！"); return; }
            if (!validateChargingMapData(dataInput)) { alert("数据格式不正确，请检查输入格式！"); return; }
            if (!parseDataFromInput()) { alert("数据解析失败，请检查输入格式！"); return; }
            const name = dataNameInput || `充电map ${new Date().toLocaleString()}`;
            addToHistoryWithName(name);
            updateDataPreview();
            closeModal('data-modal');
            simulateAndUpdate();
        }
        
        function addToHistoryWithName(name) {
            if (!currentMatrixData) return;
            const dataInput = document.getElementById('data-input').value.trim();
            const existingIndex = historyData.findIndex(item => item.data === dataInput);
            const historyItem = {
                name: name,
                data: dataInput,
                tempCount: currentMatrixData.tempAxis.length,
                socCount: currentMatrixData.socAxis.length,
                timestamp: Date.now()
            };
            if (existingIndex >= 0) historyData[existingIndex] = historyItem;
            else historyData.push(historyItem);
            saveHistory();
            updateHistoryList('data');
            currentDataName = name;
        }
        
        function updateDataPreview() {
            if (!currentMatrixData) {
                document.getElementById('current-data-name').textContent = '等待数据加载...';
                document.getElementById('data-status').textContent = '未加载';
                document.getElementById('temp-range').textContent = '--';
                document.getElementById('soc-range').textContent = '--';
                document.getElementById('data-points').textContent = '--';
                document.getElementById('thermal-status').textContent = '温升: --';
                return;
            }
            const { tempAxis, socAxis } = currentMatrixData;
            const tempMin = Math.min(...tempAxis), tempMax = Math.max(...tempAxis);
            const socMin = Math.min(...socAxis), socMax = Math.max(...socAxis);
            document.getElementById('current-data-name').textContent = '参数配置总览';
            document.getElementById('data-status').textContent = '已加载';
            document.getElementById('temp-range').textContent = `${tempMin}°C ~ ${tempMax}°C`;
            document.getElementById('soc-range').textContent = `${socMin}% ~ ${socMax}%`;
            document.getElementById('data-points').textContent = `${tempAxis.length}×${socAxis.length} 矩阵`;
            const thermalStatus = enableTempChange ? `温升: 已启用 (${thermalParams.batteryMass}kg)` : '温升: 未启用';
            document.getElementById('thermal-status').textContent = thermalStatus;
            const tempSlider = document.getElementById('temperature');
            tempSlider.min = tempMin;
            tempSlider.max = tempMax;
            const currentTemp = parseFloat(tempSlider.value);
            if (currentTemp < tempMin || currentTemp > tempMax) {
                const newTemp = Math.max(tempMin, Math.min(tempMax, (tempMin + tempMax) / 2));
                tempSlider.value = newTemp;
                document.getElementById('temperature-value').textContent = newTemp.toFixed(1);
            }
        }
        
        function updateThermalPreview() {
            updateTempStatusIndicator();
        }
        
        function updateTempStatusIndicator() {
            const isEnabled = document.getElementById('enable-temp-change-modal').checked;
            const statusValue = document.getElementById('temp-status-value');
            if (isEnabled) {
                statusValue.textContent = '已启用';
                statusValue.style.color = 'var(--primary-color)';
            } else {
                statusValue.textContent = '未启用';
                statusValue.style.color = '#666';
            }
        }
        
        function updateCurrentValue() {
            if (!currentMatrixData) return;
            const temp = parseFloat(document.getElementById('temperature').value);
            const soc = parseFloat(document.getElementById('start-soc').value);
            const current = bilinearInterpolation(temp, soc);
            document.getElementById('current-current').textContent = current.toFixed(1) + ' A';
        }
        
        function parseDataFromInput() {
            const dataInput = document.getElementById('data-input').value.trim();
            if (!dataInput) { currentMatrixData = null; return false; }
            try {
                const lines = dataInput.split('\n').map(line => line.trim()).filter(line => line);
                if (lines.length < 2) return false;
                const header = lines[0].split(/\t|\s{2,}/);
                if (header[0].toLowerCase().includes('温度') && header[0].toLowerCase().includes('soc')) header[0] = '温度';
                const socAxis = header.slice(1).map(val => parseFloat(val));
                const tempAxis = [];
                const currentMatrix = [];
                for (let i = 1; i < lines.length; i++) {
                    const row = lines[i].split(/\t|\s{2,}/);
                    if (row.length < 2) continue;
                    const temp = parseFloat(row[0]);
                    if (isNaN(temp)) continue;
                    tempAxis.push(temp);
                    const currentRow = row.slice(1).map(val => parseFloat(val));
                    currentMatrix.push(currentRow);
                }
                if (tempAxis.length === 0 || socAxis.length === 0) return false;
                for (let i = 0; i < tempAxis.length; i++) {
                    if (currentMatrix[i].length !== socAxis.length) {
                        console.warn(`第${i+2}行列数不匹配`);
                        return false;
                    }
                }
                currentMatrixData = { tempAxis, socAxis, currentMatrix };
                updateCurrentValue();
                return true;
            } catch (error) {
                console.error("数据解析错误:", error);
                return false;
            }
        }
        
        // ---------- 双线性插值 ----------
        function bilinearInterpolation(temp, soc) {
            if (!currentMatrixData) return 0;
            const { tempAxis, socAxis, currentMatrix } = currentMatrixData;
            let tempIndex1 = -1, tempIndex2 = -1;
            for (let i = 0; i < tempAxis.length; i++) {
                if (tempAxis[i] <= temp) tempIndex1 = i;
                if (tempAxis[i] >= temp && tempIndex2 === -1) tempIndex2 = i;
            }
            if (tempIndex1 === -1) tempIndex1 = 0;
            if (tempIndex2 === -1) tempIndex2 = tempAxis.length - 1;
            if (tempIndex1 === tempIndex2) {
                if (tempIndex1 > 0) tempIndex1--;
                else tempIndex2++;
            }
            let socIndex1 = -1, socIndex2 = -1;
            for (let i = 0; i < socAxis.length; i++) {
                if (socAxis[i] <= soc) socIndex1 = i;
                if (socAxis[i] >= soc && socIndex2 === -1) socIndex2 = i;
            }
            if (socIndex1 === -1) socIndex1 = 0;
            if (socIndex2 === -1) socIndex2 = socAxis.length - 1;
            if (socIndex1 === socIndex2) {
                if (socIndex1 > 0) socIndex1--;
                else socIndex2++;
            }
            const q11 = currentMatrix[tempIndex1][socIndex1];
            const q12 = currentMatrix[tempIndex1][socIndex2];
            const q21 = currentMatrix[tempIndex2][socIndex1];
            const q22 = currentMatrix[tempIndex2][socIndex2];
            const x1 = tempAxis[tempIndex1], x2 = tempAxis[tempIndex2];
            const y1 = socAxis[socIndex1], y2 = socAxis[socIndex2];
            const f1 = ((x2 - temp) / (x2 - x1)) * q11 + ((temp - x1) / (x2 - x1)) * q21;
            const f2 = ((x2 - temp) / (x2 - x1)) * q12 + ((temp - x1) / (x2 - x1)) * q22;
            return ((y2 - soc) / (y2 - y1)) * f1 + ((soc - y1) / (y2 - y1)) * f2;
        }
        
        // ---------- 充电模拟 ----------
        function simulateCharging() {
            if (!currentMatrixData) return;
            const capacity = parseFloat(document.getElementById('capacity').value);
            const startSOC = parseFloat(document.getElementById('start-soc').value);
            const endSOC = parseFloat(document.getElementById('end-soc').value);
            const ambientTemp = parseFloat(document.getElementById('temperature').value);
            if (isNaN(capacity) || capacity <= 0) { alert("请输入有效的电池容量！"); return; }
            const stepSOC = 0.1;
            const socIncrement = endSOC - startSOC;
            const steps = Math.ceil(socIncrement / stepSOC);
            let totalTime = 0, totalCurrent = 0;
            const dataPoints = [];
            temperatureHistory = [];
            let currentTemp = ambientTemp;
            let maxTemp = ambientTemp, maxTempRise = 0;
            if (enableTempChange) temperatureHistory.push({ time: 0, temp: currentTemp });
            for (let i = 0; i < steps; i++) {
                const currentSOC = startSOC + i * stepSOC;
                const nextSOC = Math.min(currentSOC + stepSOC, endSOC);
                const deltaSOC = nextSOC - currentSOC;
                const deltaQ = (deltaSOC / 100) * capacity;
                const current = bilinearInterpolation(currentTemp, currentSOC);
                if (current > 0) {
                    const deltaTime = (deltaQ / current) * 3600;
                    totalTime += deltaTime;
                    totalCurrent += current;
                    if (enableTempChange) {
                        const heatPower = Math.pow(current, 2) * thermalParams.internalResistance;
                        const heatLoss = (currentTemp - ambientTemp) / thermalParams.thermalResistance;
                        const netHeatPower = heatPower - heatLoss;
                        const deltaTemp = (netHeatPower * deltaTime) / (thermalParams.batteryMass * thermalParams.specificHeat);
                        currentTemp += deltaTemp;
                        if (currentTemp > maxTemp) {
                            maxTemp = currentTemp;
                            maxTempRise = maxTemp - ambientTemp;
                        }
                        if (i % Math.max(1, Math.floor(steps / 50)) === 0 || i === steps - 1) {
                            temperatureHistory.push({ time: totalTime / 60, temp: currentTemp });
                        }
                    }
                }
                if (i % Math.max(1, Math.floor(steps / 200)) === 0 || i === steps - 1) {
                    dataPoints.push({ time: totalTime / 60, soc: nextSOC, current: current, temperature: currentTemp });
                }
            }
            simulationResults = {
                totalTime, avgCurrent: totalCurrent / steps, steps, socIncrement,
                dataPoints, finalSOC: endSOC,
                currentAtEnd: bilinearInterpolation(currentTemp, endSOC),
                finalTemperature: currentTemp, ambientTemperature: ambientTemp,
                maxTemperature: maxTemp, maxTempRise, enableTempChange, temperatureHistory
            };
        }
        
        function updateUI() {
            if (!simulationResults) {
                document.getElementById('result-time').textContent = '--';
                document.getElementById('avg-current').textContent = '-- A';
                document.getElementById('soc-increment').textContent = '-- %';
                document.getElementById('steps-count').textContent = '--';
                return;
            }
            const totalSeconds = simulationResults.totalTime;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            let timeString = "";
            if (hours > 0) timeString += `${hours}小时`;
            if (minutes > 0) timeString += `${minutes}分`;
            if (seconds > 0 || (hours === 0 && minutes === 0)) timeString += `${seconds}秒`;
            document.getElementById('result-time').textContent = timeString || "0秒";
            const currentTemp = parseFloat(document.getElementById('temperature').value);
            const currentSOC = parseFloat(document.getElementById('start-soc').value);
            const currentCurrent = bilinearInterpolation(currentTemp, currentSOC);
            document.getElementById('current-current').textContent = `${currentCurrent.toFixed(1)} A`;
            document.getElementById('avg-current').textContent = `${simulationResults.avgCurrent.toFixed(1)} A`;
            document.getElementById('soc-increment').textContent = `${simulationResults.socIncrement.toFixed(1)} %`;
            document.getElementById('steps-count').textContent = `${simulationResults.steps}`;
        }
        
        // ---------- 计算合适的刻度间隔（标准步长）----------
        function calculateNiceInterval(maxTime) {
            maxTime = Math.max(maxTime, 0.1);
            if (maxTime <= 1) return 0.2;
            if (maxTime <= 5) return 0.5;
            if (maxTime <= 10) return 1;
            if (maxTime <= 20) return 2;
            if (maxTime <= 30) return 5;
            if (maxTime <= 60) return 10;
            if (maxTime <= 120) return 15;
            return 30;
        }
        
        // ---------- 初始化图表（关键修复：X轴标签不显示0.0，不显示非步长倍数的最大值）----------
        function initChart() {
            const chartDom = document.getElementById('chart-container');
            chartInstance = echarts.init(chartDom);
            const option = {
                title: {
                    text: '充电过程曲线',
                    left: 'center',
                    textStyle: { fontSize: 16, fontWeight: 'normal', color: '#333' }
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        let result = '';
                        const socParam = params.find(p => p.seriesName === 'SOC (%)');
                        const currentParam = params.find(p => p.seriesName === '充电电流 (A)');
                        if (socParam) result += `${socParam.seriesName}: ${socParam.value[1].toFixed(1)} %<br>`;
                        if (currentParam) result += `${currentParam.seriesName}: ${currentParam.value[1].toFixed(1)} A`;
                        return result;
                    },
                    backgroundColor: 'rgba(50,50,50,0.9)',
                    borderColor: '#333',
                    textStyle: { color: '#fff' },
                    axisPointer: { type: 'cross', label: { backgroundColor: '#6a7985' } }
                },
                legend: {
                    data: ['SOC (%)', '充电电流 (A)'],
                    top: 30,
                    textStyle: { fontSize: 12 }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'value',
                    name: '时间 (分钟)',
                    nameLocation: 'middle',
                    nameGap: 25,
                    min: 0,
                    axisLine: { lineStyle: { color: '#999' } },
                    splitLine: { lineStyle: { type: 'dashed', color: '#eee' } },
                    axisLabel: {
                        // 关键设置：
                        showMinLabel: false,        // 强制不显示最小值0.0
                        showMaxLabel: false,        // 强制不显示最大值（无论是否整数倍，都不显示）
                        interval: function(index, value) {
                            // 只显示标准步长整数倍（允许浮点误差）
                            const interval = this.interval;
                            if (value === 0) return false;  // 额外保险
                            const remainder = Math.abs(value % interval);
                            const isMultiple = remainder < 1e-8 || Math.abs(remainder - interval) < 1e-8;
                            return isMultiple;
                        },
                        formatter: function(value) {
                            if (value < 1) return value.toFixed(1);
                            return Math.round(value).toString();
                        }
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'SOC (%)',
                        min: 0,
                        max: 100,
                        position: 'left',
                        axisLine: { lineStyle: { color: '#4CAF50' } },
                        axisLabel: { formatter: '{value}%' },
                        splitLine: { lineStyle: { type: 'dashed', color: '#eee' } }
                    },
                    {
                        type: 'value',
                        name: '电流 (A)',
                        position: 'right',
                        axisLine: { lineStyle: { color: '#2196F3' } },
                        axisLabel: { formatter: '{value} A' },
                        splitLine: { show: false }
                    }
                ],
                series: [
                    {
                        name: 'SOC (%)',
                        type: 'line',
                        yAxisIndex: 0,
                        smooth: true,
                        showSymbol: false,
                        lineStyle: { width: 3, color: '#4CAF50' },
                        itemStyle: { color: '#4CAF50' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(76,175,80,0.3)' },
                                { offset: 1, color: 'rgba(76,175,80,0.05)' }
                            ])
                        }
                    },
                    {
                        name: '充电电流 (A)',
                        type: 'line',
                        yAxisIndex: 1,
                        smooth: true,
                        showSymbol: false,
                        lineStyle: { width: 2, color: '#2196F3' },
                        itemStyle: { color: '#2196F3' }
                    }
                ]
            };
            chartInstance.setOption(option);
            window.addEventListener('resize', () => chartInstance.resize());
        }
        
        // ---------- 更新图表数据：X轴终点精确，不取整；无任何graphic----------
        function updateChart() {
            if (!simulationResults || !chartInstance) return;
            const socData = [], currentData = [];
            let maxTime = 0;
            simulationResults.dataPoints.forEach(point => {
                socData.push([point.time, point.soc]);
                currentData.push([point.time, point.current]);
                if (point.time > maxTime) maxTime = point.time;
            });
            const interval = calculateNiceInterval(maxTime);
            // X轴最大值直接设为精确充电时长，不取整
            chartInstance.setOption({
                xAxis: {
                    max: maxTime,
                    interval: interval,
                    axisLabel: {
                        showMinLabel: false,
                        showMaxLabel: false,
                        interval: function(index, value) {
                            const interval = this.interval;
                            if (value === 0) return false;
                            const remainder = Math.abs(value % interval);
                            const isMultiple = remainder < 1e-8 || Math.abs(remainder - interval) < 1e-8;
                            return isMultiple;
                        }
                    }
                },
                series: [
                    { data: socData },
                    { data: currentData }
                ],
                // 彻底清空所有辅助线、文本，保证纯净
                graphic: []
            });
        }
        
        function simulateAndUpdate() {
            if (!parseDataFromInput()) {
                alert("数据解析失败，请检查输入格式！");
                return;
            }
            simulateCharging();
            updateUI();
            updateChart();
        }
        
        function resetSimulation() {
            document.getElementById('capacity').value = 80;
            document.getElementById('capacity-value').textContent = '80 Ah';
            document.getElementById('start-soc').value = 10;
            document.getElementById('start-soc-value').textContent = '10.0';
            document.getElementById('end-soc').value = 80;
            document.getElementById('end-soc-value').textContent = '80.0';
            document.getElementById('temperature').value = 25;
            document.getElementById('temperature-value').textContent = '25.0';
            document.getElementById('end-soc-hint').classList.add('hidden');
            
            enableTempChange = false;
            thermalParams = { batteryMass: 300, specificHeat: 900, thermalResistance: 0.2, internalResistance: 0.05 };
            document.getElementById('enable-temp-change-modal').checked = false;
            document.getElementById('battery-mass-modal').value = 300;
            document.getElementById('specific-heat-modal').value = 900;
            document.getElementById('thermal-resistance-modal').value = 0.2;
            document.getElementById('internal-resistance-modal').value = 0.05;
            document.getElementById('thermal-config-name-input').value = "温升配置总览";
            
            updateThermalPreview();
            updateDataPreview();
            
            document.getElementById('result-time').textContent = '--';
            document.getElementById('current-current').textContent = '125.0 A';
            document.getElementById('avg-current').textContent = '-- A';
            document.getElementById('soc-increment').textContent = '-- %';
            document.getElementById('steps-count').textContent = '--';
            
            chartInstance.setOption({
                xAxis: { max: null, interval: null },
                series: [ { data: [] }, { data: [] } ],
                graphic: []
            });
            
            parseDataFromInput();
            updateDataPreview();
        }
        
        function exportReport() {
            if (!simulationResults) { alert("请先进行计算，然后再导出报告"); return; }
            const report = `
充电时长模型报告（包含温度变化）
========================

基本参数：
- 电池容量: ${document.getElementById('capacity').value} Ah
- 起始SOC: ${document.getElementById('start-soc').value}%
- 目标SOC: ${document.getElementById('end-soc').value}%
- 环境温度: ${document.getElementById('temperature').value}°C
- 充电map: ${currentDataName}

热参数：
- 启用温度变化: ${enableTempChange ? '是' : '否'}
- 电池质量: ${thermalParams.batteryMass} kg
- 比热容: ${thermalParams.specificHeat} J/kg·K
- 热阻系数: ${thermalParams.thermalResistance} K/W
- 内阻: ${thermalParams.internalResistance} Ω

计算结果：
- 预计充电时长: ${document.getElementById('result-time').textContent}
- 当前充电电流: ${document.getElementById('current-current').textContent}
- 平均充电电流: ${document.getElementById('avg-current').textContent}
- SOC增量: ${document.getElementById('soc-increment').textContent}
- 计算步数: ${document.getElementById('steps-count').textContent}

模拟时间: ${new Date().toLocaleString()}
            `.trim();
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `充电时长模型报告_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function clearHistory() {
            historyData = [];
            thermalHistoryData = [];
            saveHistory();
            updateHistoryList('data');
            updateHistoryList('thermal');
            alert("历史记录已清空");
        }
    </script>
</body>
</html>